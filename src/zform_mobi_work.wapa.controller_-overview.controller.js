sap.ui.define([                                                                                                                                                                                                                                                
    "sap/ui/core/mvc/Controller",                                                                                                                                                                                                                              
    "sap/ui/core/ValueState",                                                                                                                                                                                                                                  
    "sap/ui/model/json/JSONModel",                                                                                                                                                                                                                             
    "sap/ui/core/Fragment",                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
    "sap/ui/model/FilterOperator",                                                                                                                                                                                                                             
    "sap/ui/model/Filter"                                                                                                                                                                                                                                      
], function (                                                                                                                                                                                                                                                  
    Controller,                                                                                                                                                                                                                                                
    ValueState,                                                                                                                                                                                                                                                
    JSONModel,                                                                                                                                                                                                                                                 
    Fragment,                                                                                                                                                                                                                                                  
    FilterOperator,                                                                                                                                                                                                                                            
    Filter                                                                                                                                                                                                                                                     
) {                                                                                                                                                                                                                                                            
    "use strict";                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
    return Controller.extend("com.steb.mobileWork.controller.Overview", {                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
        navigateToCreate: function () {                                                                                                                                                                                                                        
            this.getOwnerComponent().getRouter().navTo("create")                                                                                                                                                                                               
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        displayForm: function (event) {                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
            const binding = event.getSource().getBindingContext("main")                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
            const beginDate = binding.getProperty("beginDate"),                                                                                                                                                                                                
                endDate = binding.getProperty("endDate")                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
            this.getOwnerComponent().getRouter().navTo("display", { "?query": { begin: beginDate, end: endDate } })                                                                                                                                            
        },                                                                                                                                                                                                                                                     
        formatStatusText: function (status) {                                                                                                                                                                                                                  
            if (status == 0) return 'gesendet'                                                                                                                                                                                                                 
            if (status == -1) return 'abgelehnt'                                                                                                                                                                                                               
            if (status == 3) return 'genehmigt'                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
            return `${status} von 3`                                                                                                                                                                                                                           
        },                                                                                                                                                                                                                                                     
        formatStatusState: function (status) {                                                                                                                                                                                                                 
            if (status == 0) return ValueState.Warning                                                                                                                                                                                                         
            if (status == -1) return ValueState.Error                                                                                                                                                                                                          
            if (status == 3) return ValueState.Success                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
            return ValueState.Warning                                                                                                                                                                                                                          
        },                                                                                                                                                                                                                                                     
        openNotes: async function (event) {                                                                                                                                                                                                                    
            const view = this.getView()                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
            // event.getSource().getParent().getCustomData().find(c => c.getKey() == "headerId")                                                                                                                                                               
                                                                                                                                                                                                                                                               
            // const testData = {                                                                                                                                                                                                                              
            //     notes: [{                                                                                                                                                                                                                                   
            //         sender: "12345678",                                                                                                                                                                                                                     
            //         info: 0,                                                                                                                                                                                                                                
            //         timestamp: new Date(),                                                                                                                                                                                                                  
            //         text: "abgelehnt weil warum auch nicht"                                                                                                                                                                                                 
            //     }]                                                                                                                                                                                                                                          
            // }                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
            // const model = new sap.ui.model.json.JSONModel(testData, "test")                                                                                                                                                                                 
            // this.getView().setModel(model)                                                                                                                                                                                                                  
            const headerId = event.getSource().getParent().getCustomData().find(c => c.getKey() == "headerId").getValue()                                                                                                                                      
                                                                                                                                                                                                                                                               
            var filter = new Filter('headerId', FilterOperator.EQ, headerId);                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
            if (!this._noteDialog) {                                                                                                                                                                                                                           
                this._noteDialog = await Fragment.load({                                                                                                                                                                                                       
                    id: view.getId(),                                                                                                                                                                                                                          
                    name: "com.steb.mobileWork.fragments.NoteDialog",                                                                                                                                                                                          
                    controller: this                                                                                                                                                                                                                           
                })                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                view.addDependent(this._noteDialog)                                                                                                                                                                                                            
                // this.byId("noteList").getBinding("items").filter(filter)                                                                                                                                                                                    
            } else {                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
                // this.byId("noteList").removeAllItems()                                                                                                                                                                                                      
            }                                                                                                                                                                                                                                                  
            this.byId("noteList").getBinding("items").filter(filter)                                                                                                                                                                                           
            // Seite busy setzen anstatt Dialog zu öffnen. Dialog wird durch Event updatefinished geöffnet&nbsp;                                                                                                                                               
            this.byId("page").setBusy(true)                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
        },                                                                                                                                                                                                                                                     
        closeNotes: function () {                                                                                                                                                                                                                              
            this._noteDialog?.close()                                                                                                                                                                                                                          
        },                                                                                                                                                                                                                                                     
        formatStep: function (step) {                                                                                                                                                                                                                          
            return step == -1 ? 'abgelehnt' : 'genehmigt'                                                                                                                                                                                                      
        },                                                                                                                                                                                                                                                     
        updateFinished: function () {                                                                                                                                                                                                                          
            this.byId("page").setBusy(false)                                                                                                                                                                                                                   
            this._noteDialog?.open()                                                                                                                                                                                                                           
        }                                                                                                                                                                                                                                                      
    });                                                                                                                                                                                                                                                        
});                                                                                                                                                                                                                                                            